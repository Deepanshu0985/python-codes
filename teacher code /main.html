<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!--Materialise-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Materialise-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!--Materialise-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Materialise-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!--Reading Excel Files-->
    <script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
    <!--Swal-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      .header_row {
        width: 100%;
        display: flex;
      }
      .w_two_zero_center {
        width: 20%;
        text-align: center;
      }

      tr, td, th {
        border: 1px solid white;
        /* border-collapse: collapse; */
        text-align: center;
        padding: 16px;
      }
      tr.selected {
        background-color: yellow;
      }
      td.selected{
        background-color: yellow;
      }
      table.center {
        margin-left: auto;
        margin-right: auto;
      }
      table {
        border: 1px solid black;
        border-collapse: collapse;
        width: 100%;
        text-align: center;
        padding: 0px;
      }
      table.variableWidth {
        table-layout: fixed;
        border: 1px solid black;
        border-collapse: collapse;
        width: 100%;
        text-align: center;
        padding: 0px;
      }
      h1{
        background: teal;
        color: white;
        text-align: left;
        padding: 5px
      }
      h2{
        background: #f5fff5;
        text-align: center;
      }
      h3{
        background: #f5fff5;
      }
      .mostly-customized-scrollbar::-webkit-scrollbar {
        width: 5px;
        height: 8px;
        background-color: #aaa;
      }

      /* Add a thumb */
      .mostly-customized-scrollbar::-webkit-scrollbar-thumb {
        background: #000;
      }
    </style>
    <script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
  </head>
  <body>
    <div class="container col s12" id="mainDiv">
      <h1><img src ="https://lh3.google.com/u/0/d/1a_HKCI1HE3Usy8lQBwKE9jTfJw0tiDrN" style="width:62;height:57px;"> Bakliwal Tutorials</h1>
      <h2 id="myHeader">1 to 1 Teacher - Student Interaction</h2>
      <div id="studentTeacherInteraction" style = "display:none">
        <div class = "row">
          <div class = "col s6">
            <label for = "teacherCodeTextBox">Faculty Code</label>
            <input id="teacherCodeTextBox" type="text" class="input-field" disabled>
          </div>
          <div class = "col s6">
            <label for="allocatedBatchesTextBox">Allocated Batches</label>
            <input id="allocatedBatchesTextBox" type="text" class="input-field" disabled>
          </div>
        </div>
        <div class = "row"></div>
        <div class = "row" id="scheduledMeetingsDiv" style="display:none">
          <h2>Your Upcoming Slots</h2>
          <!-- <p style="font-size:0.9rem;"><b class="red-text" >Note:</b> All your slots are of 3.5 hours duration</p> -->
          <!-- <div class="container col s12" style="width: 100%; max-height: 210px; overflow: auto;">
            <table id="scheduleTable"></table>
          </div> -->
        </div>
        <div id="teacherScheduleDiv" class="row"></div>
        <!-- <div class="row">
          <div id="subjectDropdownDiv" class="col s12">
            <div class="input-field">
              <select id = "subjectDropdown" class="browser-default" onchange="onDropdownValChange()">
                <option value="" selected disabled>Select Subject</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Maths">Maths</option>
              </select>
            </div>
          </div>
        </div>
        <div class = "row"></div>
        <div class = "row">
          <div class="container col s12" style="width: 100%; max-height: 400px; overflow: auto;">
            <table id="slotDataTable"></table>
          </div>
        </div> -->
      </div>
      <script>
        let teacherCode = "";
        let allocatedBatches = "";
        let teacherScheduleArr = [];
        document.addEventListener('DOMContentLoaded', function() {

          google.script.url.getLocation(function(location) {
            google.script.run.withSuccessHandler(onSuccessInit).withFailureHandler(onFailureInit).initHash(location.hash);
          });

          function onFailureInit(e){
            document.getElementById('studentTeacherInteraction').innerHTML = '☠ Wrong Link is being used. Kindly Check ☠';
            document.getElementById('studentTeacherInteraction').style.display = 'block';
          }

          function onSuccessInit(data){
            console.log(data)
            teacherCode = data.teacherCode;
            allocatedBatches = data.allocatedBatches;
            teacherScheduleArr = data.meetingDataOfTeacher;
            // console.log("teacherscheduled arrar     =    ",teacherScheduleArr)

            if (teacherCode === "☠ Wrong Link ☠"){
              document.getElementById('studentTeacherInteraction').innerHTML = '☠ Wrong Link is being used. Kindly Check ☠';
              document.getElementById('studentTeacherInteraction').style.display = 'block';
              return;
            }

            document.getElementById("teacherCodeTextBox").value = teacherCode;
            document.getElementById("allocatedBatchesTextBox").value = allocatedBatches;
            fillScheduleTable(teacherScheduleArr);
            document.getElementById("studentTeacherInteraction").style.display = "block";
          }
        });

        // function fillScheduleTable(schedule){
        //   let table = document.getElementById("scheduleTable");
        //   if (schedule){
        //     schedule.forEach((row, i)=>{
        //       if(i>0){
        //         var tRow = table.insertRow(-1);
        //         row.forEach((c, j)=>{
        //           if (j > 0){
        //             let cell = tRow.insertCell(-1);
        //             if (j != scheduleTableZoomLinkCol) cell.innerHTML = c;
        //             else if (row[scheduleTableZoomLinkCol]) {
        //               cell.innerHTML = `<a href="${generateZoomLink(row[scheduleTableMeetingIDCol], row[scheduleTablePasswordCol])}" target="_blank">Zoom Link</a>`;
        //             }
        //           }
        //         });
        //       }else{
        //         var tRow = table.createTHead().insertRow(0);
        //         tRow.style.background = "teal";
        //         tRow.style.color = "#ffffff";
        //         tRow.style.position = 'sticky';
        //         row.forEach((c, j)=>{
        //           if (j > 0) tRow.insertCell(-1).innerHTML = "<b>"+c+"</b>";
        //         });
        //       }
        //     });
        //     document.getElementById("scheduledMeetingsDiv").style.display = "block";
        //   }
        // }

        let scheduleTableSlotUIDCol = 0;
        let scheduleTableDateCol = 1;
        let scheduleTableTimeSlotCol = 2;
        let scheduleTableZoomLinkCol = 3;
        let scheduleTableMeetingIDCol = 4;
        let scheduleTablePasswordCol = 5;
        let scheduleTableMeetingUIDCol = 6;
        let scheduleTableRollNoCol = 7;
        let scheduleTableStudNameCol = 8;
        let scheduleTableBatchNameCol = 9;
        let scheduleTableMeetIntervalCol = 10;
        let scheduleTableMeetRemarksCol = 11;
        function fillScheduleTable(schedule){
          // console.log("schedule. =. ",schedule)
          document.getElementById("teacherScheduleDiv").innerHTML = "";
          if (!schedule || schedule.length == 0) {
            document.getElementById("teacherScheduleDiv").innerHTML = `
            <p style="font-size:0.9rem;">
              <b class="red-text">No slots found. If there are any concerns, kindly contact academics</b>
            </p>`;
            return;
          }
          let html_rows = `<div class="col s12" style="padding:0 2.75rem; position:sticky; top:0; background-color : white;">
            <table>
              <thead>
                <tr>
                  <th class="w_two_zero_center">${schedule[0][scheduleTableDateCol]}</th>
                  <th class="w_two_zero_center">${schedule[0][scheduleTableTimeSlotCol]}</th>
                  <th class="w_two_zero_center">${schedule[0][scheduleTableZoomLinkCol]}</th>
                  <th class="w_two_zero_center">${schedule[0][scheduleTableMeetingIDCol]}</th>
                  <th class="w_two_zero_center">${schedule[0][scheduleTablePasswordCol]}</th>
                </tr>
              </thead>
            </table>
            </div>
            <ul class="col s12 collapsible expandable popout mostly-customized-scrollbar" style="max-height:50vh; overflow-y:auto;">`;

          for(let i=1 ; i<schedule.length;){
            let temp_i = i;
            let hist_html = "";
            // if(i+1 < schedule.length && schedule[i][0] == schedule[i+1][0]){
            if(schedule[i][scheduleTableRollNoCol]){
              hist_html = `<table class="highlight centered responsive-table"><thead><tr><th>Roll No</th><th>Student Name</th><th>Batch</th><th>Meeting Interval</th><th>Meeting Remarks</th></tr></thead><tbody>`;
              let j = i;
              while(j < schedule.length && ((j == i && schedule[i][scheduleTableRollNoCol]) || schedule[i][0] == schedule[i+1][0])){
                hist_html += `<tr>
                <td>${schedule[j][scheduleTableRollNoCol]}</td>
                <td>${schedule[j][scheduleTableStudNameCol]}</td>
                <td>${schedule[j][scheduleTableBatchNameCol]}</td>
                <td>${schedule[j][scheduleTableMeetIntervalCol]}</td>
                <td id="remark${j}" onclick="open_modal_box(${j}, '${schedule[j][scheduleTableMeetingUIDCol]}')" style="cursor:pointer;">${schedule[j][scheduleTableMeetRemarksCol]?schedule[j][scheduleTableMeetRemarksCol].replace(/\n/g, '<br>'):"-"}</td>
                </tr>`;
                j++;
              }

              // <td><i data-target="modal${i}" id="edit_${i}" onclick="open_modal_box(remark${j}, ${schedule[j][scheduleTableMeetRemarksCol]?"'" + schedule[j][scheduleTableMeetRemarksCol] + "'": "''"}, '${schedule[j][scheduleTableMeetingUIDCol]}')" class="material-icons" style="cursor:pointer;">create</i></td>

              hist_html += `</tbody></table>`

              i = j;
            }else{
              hist_html = `<span class=" red-text text-darken-1">No student has selected this slot yet!</span>`;

              i++;
            }

            html_rows += `
                <li>
                  <div class="collapsible-header" style="display:block;">
                    <div class="header_row" >
                      <div class="w_two_zero_center">${formattingDate(schedule[temp_i][scheduleTableDateCol])}</div>
                      <div class="w_two_zero_center">${schedule[temp_i][scheduleTableTimeSlotCol]}</div>
                      <div class="w_two_zero_center">${schedule[temp_i][scheduleTableZoomLinkCol]?`<a href="${schedule[temp_i][scheduleTableZoomLinkCol]}" target="_blank">Zoom Link</a>`:``}</div>
                      <div class="w_two_zero_center">${schedule[temp_i][scheduleTableMeetingIDCol]}</div>
                      <div class="w_two_zero_center">${schedule[temp_i][scheduleTablePasswordCol]}</div>
                    </div>
                  </div>
                  <div class="collapsible-body">
                    ${hist_html}
                  </div>
                </li>
            `;
          }

          html_rows += `</ul>`;
          document.getElementById("teacherScheduleDiv").innerHTML = html_rows;

          let elems_collapsible = document.querySelector('.collapsible.expandable');
          let instances = M.Collapsible.init(elems_collapsible , {accordion: false});
        }

        async function open_modal_box(id, meetingUID){
          let remarkCell = document.getElementById("remark" + id);
          const { value: text } = await Swal.fire({
            input: "textarea",
            title: "Edit Meeting Remarks",
            inputPlaceholder: "Type your remarks here...",
            inputValue: (remarkCell.innerHTML=="-"?"":remarkCell.innerHTML.replace(/<br>/g, '\n')), // Pre-fill if meetingRemarks exists
            inputAttributes: {
              "aria-label": "Type your remarks here"
            },
            showCancelButton: true,
            confirmButtonText: "Save",
            cancelButtonText: "Cancel",
            allowOutsideClick: false,
            inputValidator: (value) => {
              if (!value.trim() || value.trim().length < 3) {
                return "You must enter a valid remark!";
              }
            }
          });

          // If the user entered a remark, update the element's innerHTML
          if (text && text.length > 0) {
            document.body.style.cursor = "wait";
            google.script.run.withSuccessHandler(onSuccessUpdateRemarks).withFailureHandler(onFailureUpdateRemarks).updateMeetingRemarks(meetingUID, text)

            function onFailureUpdateRemarks(e){
              document.body.style.cursor = "default";
              Swal.fire({
                title: "Unable to update meeting remarks",
                text: "Error - " + e,
                icon: "error"
              });
            }

            function onSuccessUpdateRemarks(msg){
              document.body.style.cursor = "default";
              if (msg === "DONE"){
                remarkCell.innerHTML = text.replace(/\n/g, '<br>');
                Swal.fire("Saved!", "Your meeting remark has been updated.", "success");
              }
              else{
                Swal.fire({
                  title: "Unable to update meeting remarks",
                  text: "Error - " + msg,
                  icon: "error"
                });
              }
            }
          }
        }

        function formattingDate(dateString) {
          const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];

          // Parse the date string into a date object
          let date = new Date(dateString);
          
          let day = date.getDate();
          let month = months[date.getMonth()];
          let year = date.getFullYear();
          
          // Add suffix for day
          let daySuffix;
          if (day % 10 === 1 && day !== 11) {
            daySuffix = 'st';
          } else if (day % 10 === 2 && day !== 12) {
            daySuffix = 'nd';
          } else if (day % 10 === 3 && day !== 13) {
            daySuffix = 'rd';
          } else {
            daySuffix = 'th';
          }

          return `${day}${daySuffix} ${month}, ${year}`;
        }

        function destroyTable(tableId){
          let table = document.getElementById(tableId);
          for(let i = table.rows.length - 1; i >= 0; i--){
            table.rows[i].remove();
          }
        }

        function highlightTableCell(table, cell) {
          // Remove highlight from previously selected cell, if any
          const previouslySelectedCell = table.querySelector('td.selected');
          if (previouslySelectedCell) {
            previouslySelectedCell.classList.remove('selected');
          }

          // Highlight the clicked cell
          cell.classList.add('selected');
        }

      </script>
    </div>
    <div id="confirmationModal" class="modal mostly-customized-scrollbar">
      <div class="modal-content">
        <h4 id="confirmationModal_head" class="center-align" style="color:#1c4445; font-weight: bolder;">Select Teacher and Confirm</h4>
        <p style="font-size:0.9rem;"><b class="red-text" >Note:</b> If you do not want to select this slot then please click on <b>Close</b> at the bottom right corner of this pop-up</p>
        <div class="row"></div>
        <div id="slotConfirmationDiv" class="row" style="width:100%">
          
        </div>
      </div>
      <div class="modal-footer">
        <a class="modal-close waves-effect waves-green btn-flat">Close</a>
      </div>
    </div>
  </body>
</html>






function fillScheduleTable(schedule) {
  document.getElementById("teacherScheduleDiv").innerHTML = "";
  if (!schedule || schedule.length == 0) {
    document.getElementById("teacherScheduleDiv").innerHTML = `
      <p style="font-size:0.9rem;">
        <b class="red-text">No slots found. If there are any concerns, kindly contact academics</b>
      </p>`;
    return;
  }

  let html_rows = `
    <style>
      /* Sticky top date/slot row */
      .header_row {
        position: sticky;
        top: 0;
        background: white;
        z-index: 3;
      }
      /* Sticky student table header inside collapsible */
      .student_header {
        position: sticky;
        top: 40px; /* adjust if date row height changes */
        background: #f5fff5;
        z-index: 2;
      }
    </style>
    <div class="col s12" style="padding:0 2.75rem;">
      <table>
        <thead>
          <tr class="header_row">
            <th class="w_two_zero_center">${schedule[0][scheduleTableDateCol]}</th>
            <th class="w_two_zero_center">${schedule[0][scheduleTableTimeSlotCol]}</th>
            <th class="w_two_zero_center">${schedule[0][scheduleTableZoomLinkCol]}</th>
            <th class="w_two_zero_center">${schedule[0][scheduleTableMeetingIDCol]}</th>
            <th class="w_two_zero_center">${schedule[0][scheduleTablePasswordCol]}</th>
          </tr>
        </thead>
      </table>
    </div>
    <ul class="col s12 collapsible expandable popout mostly-customized-scrollbar" style="max-height:50vh; overflow-y:auto;">`;

  for (let i = 1; i < schedule.length;) {
    let temp_i = i;
    let hist_html = "";

    if (schedule[i][scheduleTableRollNoCol]) {
      hist_html = `<table class="highlight centered responsive-table">
        <thead>
          <tr class="student_header">
            <th>Roll No</th>
            <th>Student Name</th>
            <th>Batch</th>
            <th>Meeting Interval</th>
            <th>Meeting Remarks</th>
          </tr>
        </thead>
        <tbody>`;

      let j = i;
      while (j < schedule.length && schedule[j][scheduleTableDateCol] === schedule[i][scheduleTableDateCol]) {
        hist_html += `<tr>
          <td>${schedule[j][scheduleTableRollNoCol]}</td>
          <td>${schedule[j][scheduleTableStudNameCol]}</td>
          <td>${schedule[j][scheduleTableBatchNameCol]}</td>
          <td>${schedule[j][scheduleTableMeetIntervalCol]}</td>
          <td id="remark${j}" onclick="open_modal_box(${j}, '${schedule[j][scheduleTableMeetingUIDCol]}')" style="cursor:pointer;">
            ${schedule[j][scheduleTableMeetRemarksCol] ? schedule[j][scheduleTableMeetRemarksCol].replace(/\n/g, '<br>') : "-"}
          </td>
        </tr>`;
        j++;
      }

      hist_html += `</tbody></table>`;
      i = j;
    } else {
      hist_html = `<span class=" red-text text-darken-1">No student has selected this slot yet!</span>`;
      i++;
    }

    html_rows += `
      <li>
        <div class="collapsible-header" style="display:block;">
          <div class="header_row">
            <div class="w_two_zero_center">${formattingDate(schedule[temp_i][scheduleTableDateCol])}</div>
            <div class="w_two_zero_center">${schedule[temp_i][scheduleTableTimeSlotCol]}</div>
            <div class="w_two_zero_center">${schedule[temp_i][scheduleTableZoomLinkCol] ? `<a href="${schedule[temp_i][scheduleTableZoomLinkCol]}" target="_blank">Zoom Link</a>` : ``}</div>
            <div class="w_two_zero_center">${schedule[temp_i][scheduleTableMeetingIDCol]}</div>
            <div class="w_two_zero_center">${schedule[temp_i][scheduleTablePasswordCol]}</div>
          </div>
        </div>
        <div class="collapsible-body">
          ${hist_html}
        </div>
      </li>
    `;
  }

  html_rows += `</ul>`;
  document.getElementById("teacherScheduleDiv").innerHTML = html_rows;

  let elems_collapsible = document.querySelector('.collapsible.expandable');
  let instances = M.Collapsible.init(elems_collapsible, { accordion: false });
}

